---
title: "统一认证 OAuth2+JWT"
date: 2020-10-13T10:21:43+08:00
draft: false
tags: ["Java","Spring Cloud","OAuth2","JWT"]
---

*本文源代码下载：[spring-cloud-oauth2+jwt.zip](/file/springcloud/spring-cloud-oauth2+jwt.zip)*

认证：验证用户的合法身份，比如输入用户名和密码，系统会在后台验证⽤户名和密码是否合法， 合法的前提下，才能够进行后续的操作，访问受保护的资源

## 微服务架构下统一认证场景

分布式系统的每个服务都会有认证需求，如果每个服务都实现⼀套认证逻辑会非常冗余，考虑分布式系统共享性的特点，需要由独⽴的认证服务处理系统认证的请求。

## 微服务架构下统一认证思路

* 基于Session的认证方式

  在分布式的环境下，基于session的认证会出现⼀个问题，每个应⽤服务都需要在session中存储用户身份信息，通过负载均衡将本地的请求分配到另⼀个应用服务需要将session信息带过去，否则会重新认证。我们可以使用Session共享、Session黏贴等⽅案。

* 基于token的认证方式

  基于token的认证⽅式，服务端不用存储认证数据，易维护扩展性强， 客户端可以把token存在任意地⽅，并且可以实现web和app统⼀认证机制。其缺点也很明显，token由于⾃包含信息，因此⼀般数据量较⼤，⽽且每次请求都需要传递，因此比较占带宽。另外，token的签名验签操作也会 给cpu带来额外的处理负担。

## OAuth2 开放授权协议/标准

### OAuth2 介绍

OAuth（开放授权）是⼀个开放协议/标准，允许⽤户授权第三方应用访问他们存储在另外的服务提供者上的信息，而不需要将⽤户名和密码提供给第三⽅应用或分享他们数据的所有内容。

**允许用户授权第三⽅应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三⽅应用或分享他们数据的所有内容**

结合“使用QQ登录第三方网站”这个场景拆分理解上述那句话

用户：我们自己

第三方应用：网站

另外的服务提供者：QQ

OAuth2是OAuth协议的延续版本，但不向后兼容OAuth1即完全废除OAuth1

### OAuth2 协议角色和流程

网站要开发使用QQ登录这个功能的话，那么是需要提前到QQ平台进行登记的

1. 网站-->登记-->QQ平台
2. QQ 平台会颁发⼀些参数给网站，后续上线进行授权登录的时候（刚才打开授权⻚⾯）需要携带这些参数

client_id：客户端id （QQ最终相当于⼀个认证授权服务器，网站就相当于⼀个客户端了，所以会给⼀个客户端id），相当于账号

secret：相当于密码

* 资源所有者（Resource Owner）：可以理解为用户自己
* 客户端（Client）：我们想登陆的网站或应⽤，比如拉勾网
* 认证服务器（Authorization Server）：可以理解为微信或者QQ
* 资源服务器（Resource Server）：可以理解为微信或者QQ

### 什么情况下需要使用OAuth2

**第三⽅授权登录的场景**：比如，我们经常登录⼀些⽹站或者应⽤的时候，可以选择使⽤第三⽅授权登录 的⽅式，比如：微信授权登录、QQ授权登录、微博授权登录等，这是典型的 OAuth2 使⽤场景。

**单点登录的场景**：如果项目中有很多微服务或者公司内部有很多服务，可以专门做⼀个认证中心（充当 认证平台⻆⾊），所有的服务都要到这个认证中心做认证，只做⼀次登录，就可以在多个授权范围内的 服务中⾃由串⾏。

### OAuth2的颁发Token授权方式

1. **授权码（authorization-code）**
2. **密码式（password）提供用户名+密码换取token**
3. **隐藏式（implicit）**
4. **客户端凭证（client credentials）**

授权码模式使⽤到了回调地址，是最复杂的授权方式，微博、微信、QQ等第三⽅登录就是这种模式。 这里重点介绍接口对接中常使用的password密码模式（提供用户名+密码换取token）

## Spring Cloud OAuth2 + JWT 实现

### Spring Cloud OAuth2 介绍

Spring Cloud OAuth2 是 Spring Cloud 体系对OAuth2协议的实现，可以用来做多个微服务的统⼀认证 （验证身份合法性）授权（验证权限）。通过向OAuth2服务（统⼀认证授权服务）发送某个类型的 grant_type进行集中认证和授权，从而获得access_token（访问令牌），而这个token是受其他微服务信任的。

**注意：使用OAuth2解决问题的本质是，引⼊了⼀个认证授权层，认证授权层连接了资源的拥有者，在授权层⾥⾯，资源的拥有者可以给第三⽅应⽤授权去访问我们的某些受保护资源。**

### Spring Cloud OAuth2 构建微服务统一认证服务思路

在我们统⼀认证的场景中，Resource Server其实就是我们的各种受保护的微服务，微服务中的各种API访问接口就是资源，发起http请求的浏览器就是Client客户端（对应为第三⽅应⽤）

### 搭建认证服务器（Authorization Server）

### JWT 改造统一认证授权中心的令牌存储机制

### 从数据库加载 Oauth2 客户端信息

### 从数据库验证用户合法性

### 基于Oauth2 的 JWT 令牌信息拓展

### 资源服务器取出 JWT 令牌拓展信息

### 其他