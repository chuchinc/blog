---
title: "MySQL 架构原理 运行机制"
date: 2020-09-03T10:21:43+08:00
draft: false
tags: ["MySQL"]
---

![20201209-143324-0299.png](https://gitee.com/chuchin/img/raw/master/20201209-143324-0299.png)

1. **建立连接（Connectors&Connection Pool）**

   通过客户端/服务器通信协议与MySQL建立连 接。MySQL 客户端与服务端的通信方式是 “ 半双工 ”。对于每一个 MySQL 的连接，时刻都有一个线程状态来标识这个连接正在做什么。

   通讯机制：

   * 全双工：能同时发送和接收数据，例如平时打电话。
   * 半双工：指的某一时刻，要么发送数据，要么接收数据，不能同时。例如早期对讲机
   * 单工：只能发送数据或只能接收数据。例如单行道

   线程状态：

   show processlist; //查看用户正在运行的线程信息，root用户能查看所有线程，其他用户只能看自己的

   * id：线程ID，可以使用kill xx；
   * user：启动这个线程的用户
   * Host：发送请求的客户端的IP和端口号
   * db：当前命令在哪个库执行
   * Command：该线程正在执行的操作命令
     * Create DB：正在创建库操作
     * Drop DB：正在删除库操作
     * Execute：正在执行一个PreparedStatement
     * Close Stmt：正在关闭一个PreparedStatement
     * Query：正在执行一个语句
     * Sleep：正在等待客户端发送语句
     * Quit：正在退出
     * Shutdown：正在关闭服务器
   * Time：表示该线程处于当前状态的时间，单位是秒
   * State：线程状态
     * Updating：正在搜索匹配记录，进行修改
     * Sleeping：正在等待客户端发送新请求
     * Starting：正在执行请求处理
     * Checking table：正在检查数据表
     * Closing table : 正在将表中数据刷新到磁盘中
     * Locked：被其他查询锁住了记录
     * Sending Data：正在处理Select查询，同时将结果发送给客户端
   * Info：一般记录线程执行的语句，默认显示前100个字符。想查看完整的使用show full processlist;

2. **查询缓存（Cache&Buffer）**

   这是MySQL的一个可优化查询的地方，如果开启了查询缓存且在查询缓存过程中查询到完全相同的SQL语句，则将查询结果直接返回给客户端；如果没有开启查询缓存或者没有查询到完全相同的 SQL 语句则会由解析器进行语法语义解析，并生成“解析树”。

   * 缓存Select查询的结果和SQL语句
   * 执行Select查询时，先查询缓存，判断是否存在可用的记录集，要求是否完全相同（包括参数值），这样才会匹配缓存数据命中。
   * 即使开启查询缓存，以下SQL也不能缓存
     * 查询语句使用SQL_NO_CACHE
     * 查询的结果大于query_cache_limit设置
     * 查询中有一些不确定的参数，比如now()
   * show variables like '%query_cache%'; //查看查询缓存是否启用，空间大小，限制等
   * show status like 'Qcache%'; //查看更详细的缓存参数，可用缓存空间，缓存块，缓存多少等

3. **解析器（Parser）**

   客户端发送的SQL进行语法解析，生成"解析树"。预处理器根据一些MySQL 规则进一步检查“解析树”是否合法，例如这里将检查数据表和数据列是否存在，还会解析名字和别名，看看它们是否有歧义，最后生成新的“解析树”。

4. **查询优化器（Optimizer）**

   根据“解析树”生成最优的执行计划。MySQL使用很多优化策略生成最优的执行计划，可以分为两类：静态优化（编译时优化）、动态优化（运行时优化）。

   * 等价变换策略
     * 5=5 and a>5 改成 a > 5
     * a < b and a=5 改成b>5 and a=5
     * 基于联合索引，调整条件位置等
   * 优化count、min、max等函数
     * InnoDB引擎min函数只需要找索引最左边
     * InnoDB引擎max函数只需要找索引最右边
     * MyISAM引擎count(*)，不需要计算，直接返回
   * 提前终止查询
     * 使用了limit查询，获取limit所需的数据，就不在继续遍历后面数据
   * in的优化
     * MySQL对in查询，会先进行排序，再采用二分法查找数据。比如where id in (2,1,3)，变 成 in (1,2,3)

5. **查询执行引擎**

   负责执行 SQL 语句，此时查询执行引擎会根据 SQL 语句中表的存储引擎类型，以及对应的API接口与底层存储引擎缓存或者物理文件的交互，得到查询结果并返回给客户端。若开启用查询缓存，这时会将SQL 语句和结果完整地保存到查询缓存（Cache&Buffer）中，以后若有 相同的 SQL 语句执行则直接返回结果。

   * 如果开启了查询缓存，先将查询结果做缓存操作
   * 返回结果过多，采用增量模式返回
